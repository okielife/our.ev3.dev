from typing import List

from leeev3.geolocator.mapping import Map
from leeev3.geolocator.tolerances import Tolerances
# from leeev3.geolocator.location import Location
# flake8: noqa


class LocatorA(object):
    """
    This class is used to provide location services to a robot.
    For right now it is assuming we have two color sensors located transverse to the robot "forward"
    Things we will need:

    - A detailed description of the surface of the world (which we can provide means to get that)
    - The distance the color sensors are away from each other

    That may be it.  Here's a visual of what we're expecting:
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,,@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,%@,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&/,,,,,,,,,,,&@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,,,@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,@*/,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,(@@#@&&,,@@@&&@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,/@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,%@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@(,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,@(&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,*@,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,@#,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,*,,,,@@#@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,(@#@&(,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@@@@%*,,@@&&*@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,.,.,,,,%,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,(@..,@#,,,,,,,,,,,,,..,,,,,.,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@(,,,,,,,,,,,,,,,,,,,,,,,,,,,,%@/.,,,##,,,,,..,.,,,,,,,,,,,,,,,,,,,,,,,,,..,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,%@,,,,,,,,,.,,,,,.,,,,,,,,,...@*,&,..&.,,.,.....,,..,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,%&,,@,,,,,,,,,.....,,,...,.,.....&.@@*.....................,,,,,,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,@@,&.,,,,,..,..............,...,,.........................,,............,.....,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,,.,,.,@%@@@.........................................................................,..,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,..,,.,,,...@.........................................................................,.,,,..,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,.,,,,,,............../(,.......................,,....,.........................................,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,..,.,,,,,,,,,,,,,,,*@@*........@@@@@@/..............,.......&@@@@@@......................................,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,..,,,,,,,,,,,@@(..,@@,....&@@@@@@&..................,...,.&@..@,.................................,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,,,,,,,,,,,,,,,,,,,.,,,,,,,,,,@@,......,@%...*@@@@@&..............,..,.,..@@@,../@..............................,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,,,
    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,.,...../@@.,/&@(,/,....................,,&&.....*@......................................,,,,,,,,,,,,,,....,,,.,.,,,
    ,,,,,,,,,,,,,,,,.,,,,..,.....@/,,..*@@(..@@(..@(..............,...,@*.........,@...............................,..,,,,,,,,,,,.,.,,,,,....,.....,,.
    ,,,,,,,,,,,,,,,..,,,...,......%@..%,..,@@......@#...............%@%..,........&..................................,..,,,,,,,......,,.,....,......,.
    ,,,,,,...........,,...........,.@*../@%.........@&.,...........(/.........................,.*@....................,,,....,.,..............,..,,...
    .................,................(@%............@#........##...........................*@@%...@@.....................,.............,,......,,.,,.
    ................................@@,...............@(,...#@@,...........................#@*......(@............................,....,,,.,,.........
    ......       ................(@%...................@@.../...............................@%....../,......................,,,,,......,,,,,..........
    .....      #/..............@@,......................%@....................................,@..*@#......&/,...,.....,,,,,,,,,,.......,,.,,.........
    .....    %% #@,..........@@..........................&@......................,.............@.........,@@@@@&&&%%......,,,,......,....,..,.........
    .....  %#    .*@/,....%@%.............................#@...................,,,,,,,..,................,@&.%@@*,.,.....,,,,,,,,.....,,.,..,,....,,..
    .....     ...@@...@@.................................,@,.................,,,,,,,,,,,,,............../@..,(&&*...,,,,,,,,,,.,,,,,,,,,,,....,.,.....
    ....  &     .@@.,/@#.....................................&(........,.,,,,,,,,,,,,,,,,,,,............../@....,*&&%.,.,,,,,,,,.,,,,,,,,,,...........
    ....   &   &@..%@*........................................@&.......@@@@@.,,,,,,,,,,,,,,,.,....,,....../@.,......&%%,,,,,,,,,,,,,,,,,,........,....
    ....    &* ..@@,,..........................,,..............%&.....#@@@@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,,..,,,,,,.,%#*,,,,,,,,,,,,,,,,,........,...
    ....      %&(.......................,...,,,,,,,,,,,,,..,,.,.#&*,..@@@@@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,/%%,,,,,,,,,,,,,,,,,..,....,,,.
    ....   /&&.........................,,,,,,,,,,,,,,,,,,,,,,,,,,.&(,,,@@@%,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&&&,,,,,,,,,,,,,,,,,,,..,,,,,
    ... &%#..................,........,,,,,,,,,,,,,,,,,,,,,,,,,,,*&%,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&&,,,,,,,,,,,,,,,,,,..,,,,,
    ...  &  ................,,#&@&@..,,,,,,,,,,,,,,,,,,,,,,,,,,%@@,,,,,,,,,,,/@@@%&@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&&,,,,,,,,,,,,,,,,,..,,,,,
    ...  *& ......,,,........*@%,@@.,,,,,,,,,,,,,,,,,,,,,,,,,@&&,,,,,,,,,,,,,,@@*,#@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&%,,,,,,,,,,,,,,,,..,,,,,,.
    ...   @......,,,,.....,@@/,&@.,,,,,,,,,,,,,,,,,,,,,,,,,@@/,&@@/,,,,,,,,,,,#&,,@&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,/@,,,,,,,,,,,,,,,,,,,,,,,
    ...   .@.....,,,,...@@,,,,&%,,,,,,,,,,,,,,,,,,,,,,,,@&@,@@@,,,#@%,,,,,,,,,,,,,,@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,,,,,,,,,,,,,,,,
    ...   .(&....,.,.%@(..,,,,,..,.,,,,,,,,,,,,,,,,,,@&@,@@@,,,,,,,,/@/,,,,,,,,,,,,,#@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#@@@&/,,,,,,,,,,,,,,,,,,,,
    ........@/....../,...,,,,,,..,,,,,,,,,,,,,,,,,#@&(,,@&,,,,,,,,,,,,@,,,,,,,,,,,,,,@#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,(@@(/&@@&,,,,,,,,,@@,,,,,,,
    .........@.............,,,,,,,,,,,,,,,,,,,,,@&&,,,,,%@,,,,,,,,,,,&@,,,,,,,,,,,,,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@/,,,,%@,,,,,,@@@@@@@&,,,,
    ........,,@...........,,,,,,,,,,,,,,,,,,,@&@,,,,,,,,,@%,,,,,(@@@@#,,,,,,,,,,,,,,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@/,,&@@(,,,,,,,,,,,,,&%,,,
    .........,#&.........,,,,,,,,,,,,,,,,,&@&,,,,,,,,,,,,,@#,@@@(,,,,,,,,,,,,,,,,,,,#@%,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@/%@&,,,,,,,,,,,,,,,,%%,,,
    ...........@(........,,,,,,,,,,,,,,#@%(,,,,,,,,,,,,,,,,(#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,@@@,,,,,,,,,,,,,,,,#@,,,
    ,...........@........,,,,,,,,,,,,@&@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,@@#@,,,,,,,,,@@&,%&,,,
    ............,@.......,,,,,,,,,&&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@@@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,&@@,,,,,/@//,,,,,,,
    .............,@.....,,,,,,,,@#(,,,@@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@@,,,&@,,,,,#@%,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,,&&@,,@@@@@@%,#%&,
    ..............,@.....,,,,(@&,,,@@&,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,@@,,,,@@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ...............,@....,.@&@,,@@%,,,,,,&%,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,@@,,,,##,(@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    .................@,,.%&&,,@@,,,,,,,,,,&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&(@@&,,,,,,,,,@(,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ..................,.@&,,,(@,,,,,,,,,,,,(@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,%@@@@%,,,,,,,,@#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    .......,.......,,,,,,,,,,,/@,,,,,,,,,,,,,@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,(@@(,,,,,,,&@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    .,....,....,,,,,,,,,,,,,,,,%%,,,,,,,,,,/@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,%@,,,,,@@&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,..,,....,,,,,,,,,,,,,,,,,,,@(,,,,#@@@@#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@,,,,,,,@,,@@@@@@@@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ,..,.......,,,,,,,,,,,,,,,,,,@(@&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    ...,,,,,,,,,,,,,,,,,,,,,,,,,@&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    .,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
    """

    def __init__(self, world_map: Map, color_sensor_separation: float):
        """

        :param world_map: An instance of a derived type based on the Map class
        :param color_sensor_separation: The distance the color sensors are away from each other, in cm
        """
        self.world_map = world_map
        self.sensor_data = color_sensor_separation

    @staticmethod
    def are_colors_equal(color_a: tuple, color_b: tuple) -> bool:
        return all([abs(color_a[i] - color_b[i]) < Tolerances.ColorTolerance for i in range(3)])

    def get_possible_locations(self, color_sensed_value: tuple) -> List:
        """
        Gets a list of possible positions for a single color on the map, over a preconfigured grid interval

        Steps:
        - Loop over the world map at the preconfigured spacing, and get the color at that point
        - Check if this position matches the sensed value, to within an uncertainty value
        - Return the entire list of possible locations

        :param color_sensed_value:
        :return:
        """
        matching_points = []
        for x_number in range(Tolerances.NumberGridSamples):
            for y_number in range(Tolerances.NumberGridSamples):
                x_dimension = (x_number/Tolerances.NumberGridSamples) * self.world_map.actual_map_width
                y_dimension = (y_number / Tolerances.NumberGridSamples) * self.world_map.actual_map_height
                map_color_at_point = self.world_map.get_color_at_physical_position(x_dimension, y_dimension)
                if self.are_colors_equal(color_sensed_value, map_color_at_point):
                    matching_points.append([x_dimension, y_dimension])
        return matching_points

    def _get_possible_position_vectors(self, left_color, right_color):
        """
        Gets a list of possible position/angles given a pair of color sensed values

        :param left_color:
        :param right_color:
        :return:
        """

    def get_location_and_angle(self, left_color_1, right_color_1, left_color_2, right_color_2, distance_moved):
        """
        Get the location of the robot after moving along the map in a straight line a specified distance
        This is where we would actually try to determine where the robot is at given the perturbed data
        Note that we need to know how far the robot moved between the states
        All color calculations have a certain fuzziness built-in to the matching calculation

        I believe the steps will be something like:
        - start with initial sensed data on sensor 1, locate all spots on the map that correspond to that color
        - loop over that list, and on each one, traverse a circle around it with radius corresponding to the spacing
          of the color sensors, and locate the color of sensor 2: keep track of the location and angle of that condition
        - do a similar process for the perturbed data
        - down-select to only pairs of initial/perturbed that are parallel
        - then down-select again to only those pairs who are the specified distance apart (within tolerance)
        - if there is only one option, we are good to go!
        - if there is more than one, then we will need to call an additional worker

        :param left_color_1:
        :param right_color_1:
        :param left_color_2:
        :param right_color_2:
        :param distance_moved:
        :return:
        """
        pass

    def refine_with_third_data_set(self, initial_down_selection, left_color_3, right_color_3, distance_moved):
        """
        If the get_location_and_angle method does not give a good single option, then we can give it another attempt
        using a third measurement.  To get this third dataset, move the robot in a straight line a specified distance.
        Then pass in the results of the get_location_and_angle call, along with the third measurement.  This method will
        then call the get_location_and_angle method for
        :param initial_down_selection:
        :param left_color_3:
        :param right_color_3:
        :param distance_moved:
        :return:
        """
